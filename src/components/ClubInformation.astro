---
import { Image } from "astro:assets";
import qr_group from "@assets/images/qr_group.jpg";
import { links } from "@/data/constants";

import club from "@assets/img/club.png";
import club2 from "@assets/img/club2.png";
import club3 from "@assets/img/club3.png";
import club6 from "@assets/img/club6.png";
import club4 from "@assets/img/club4.png";
import club5 from "@assets/img/club5.png";
import type { Book } from "@/interfaces/book.interface";

const upcomingMeeting = {
  date: "Viernes 27 de diciembre",
  time: "A partir de las 12:00 p.m.",
  location: "Pastito de la entrada por la Plaza del Saber.",
};

interface Props {
  book: Book;
}
const { book } = Astro.props;

const calculateAverageRating = (ratings?: { [userId: string]: number }) => {
  if (!ratings || Object.keys(ratings).length === 0) return 0;
  const values = Object.values(ratings);
  return values.reduce((sum, rating) => sum + rating, 0) / values.length;
};

const averageRating = calculateAverageRating(book.ratings);
const totalRatings = book.ratings ? Object.keys(book.ratings).length : 0;

const renderPaws = (rating: number) => {
  const fullPaws = Math.floor(rating);
  const hasHalfPaw = rating % 1 >= 0.5;

  return Array.from({ length: 5 }, (_, i) => {
    if (i < fullPaws) return "🐾";
    if (i === fullPaws && hasHalfPaw) return "🐾";
    return "🤍";
  }).join("");
};

const getDownloadIcon = (type: string) => {
  switch (type.toLowerCase()) {
    case "pdf":
      return "📄";
    case "epub":
      return "📚";
    case "mobi":
      return "📖";
    case "audiobook":
      return "🎧";
    default:
      return "📥";
  }
};
---

<section id="info" class="py-20 bg-white">
  <div class="container mx-auto px-4">
    <h2 class="text-4xl font-bold text-slate-900 mb-12">Lectura del Momento</h2>
    <div class="flex flex-col md:flex-row items-start gap-12">
      <div class="flex-shrink-0 w-full md:w-1/2 lg:w-[350px]">
        <img
          src={book.bookImage}
          alt={book.title}
          class="w-full h-auto max-h-[500px] object-cover rounded-3xl shadow-2xl transition-transform duration-300 ease-in-out hover:scale-105"
        />
      </div>
      <div class="flex-1 space-y-8">
        <div>
          <h2 class="text-4xl font-bold text-[#66503b]">
            {book.title}
          </h2>
          <p class="text-xl text-[#66503b] mt-2">
            por {book.author}
          </p>
        </div>

        <div class="flex items-center text-[#66503b] space-x-4">
          <span>{book.pubyear}</span>
          <span class="h-4 w-px bg-[#66503b]/50"></span>
          <span>{book.category}</span>
          <span class="h-4 w-px bg-[#66503b]/50"></span>
          <span class="font-medium text-[#ea9a12]">Lectura {book.week}</span>
        </div>

        {/* Calificaciones */}
        {
          totalRatings > 0 && (
            <div class="flex items-center space-x-3">
              <div class="flex items-center text-2xl">
                {renderPaws(averageRating)}
              </div>
              <span class="text-[#66503b] font-medium">
                {averageRating.toFixed(1)}/5
              </span>
              <span class="text-[#66503b]/70 text-sm">
                ({totalRatings}{" "}
                {totalRatings === 1 ? "calificación" : "calificaciones"})
              </span>
            </div>
          )
        }

        <p class="text-[#66503b] text-lg">{book.description}</p>

        {
          book.downloads && book.downloads.length > 0 && (
            <div class="space-y-3">
              <h4 class="text-lg font-semibold text-[#66503b]">
                Recursos disponibles:
              </h4>
              <div class="flex flex-wrap gap-3">
                {book.downloads.map((download, index) => (
                  <a
                    id={"download-" + index}
                    href={download.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-[#75b3a6] to-[#4686c8] text-white rounded-full hover:from-[#4686c8] hover:to-[#75b3a6] transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                  >
                    <span class="text-lg mr-2">
                      {getDownloadIcon(download.type)}
                    </span>
                    <span class="font-medium capitalize">{download.type}</span>
                  </a>
                ))}
              </div>
            </div>
          )
        }

        <a
          href={"libros/" + book.slug}
          class="inline-flex items-center font-medium text-[#75b3a6] hover:text-[#4686c8] transition-colors duration-300 ease-in-out"
        >
          Leer Más
          <svg
            class="ml-2 h-5 w-5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
              clip-rule="evenodd"></path>
          </svg>
        </a>
      </div>
    </div>

    <div
      class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-16 translate-y-4 transition-all duration-700 ease-in-out"
    >
      <div class="bg-white rounded-3xl shadow-2xl p-8 space-y-6">
        <h3 class="text-3xl font-bold text-[#75b3a6]">Próxima Reunión</h3>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-[#66503b] font-medium">Fecha</p>
            <p class="text-lg">{upcomingMeeting.date}</p>
          </div>
          <div>
            <p class="text-[#66503b] font-medium">Hora</p>
            <p class="text-lg">{upcomingMeeting.time}</p>
          </div>
          <div class="col-span-2">
            <p class="text-[#66503b] font-medium">Ubicación</p>
            <p class="text-lg">{upcomingMeeting.location}</p>
          </div>
        </div>
      </div>
      <div
        class="bg-gradient-to-br from-[#4686c8] to-[#75b3a6] rounded-3xl shadow-2xl p-8 flex flex-col lg:flex-row items-center justify-between translate-y-4 transition-all duration-700 ease-in-out"
        style="--animate-delay: 0.3s"
      >
        <div class="space-y-2">
          <h3 class="text-3xl font-bold text-white">
            ¡Únete a Nuestra Comunidad!
          </h3>
          <p class="text-white opacity-90">
            Escanea el código QR para unirte al grupo
          </p>
        </div>
        <a href={links.whatsapp} target="_blank">
          <Image
            src={qr_group}
            alt="Código QR del Grupo"
            class="w-32 h-auto mt-4 lg:mt-0"
          />
        </a>
      </div>
    </div>

    <div
      class="mt-16 grid grid-cols-3 md:grid-cols-6 gap-6 animate__animated animate__fadeIn"
      style="--animate-delay: 0.75s"
    >
      <Image src={club} alt="Icon 1" class="w-12 h-auto mx-auto" />
      <Image src={club2} alt="Icon 2" class="w-12 h-auto mx-auto" />
      <Image src={club3} alt="Icon 3" class="w-12 h-auto mx-auto" />
      <Image src={club4} alt="Icon 4" class="w-12 h-auto mx-auto" />
      <Image src={club5} alt="Icon 5" class="w-12 h-auto mx-auto" />
      <Image src={club6} alt="Icon 6" class="w-12 h-auto mx-auto" />
    </div>
  </div>
</section>
